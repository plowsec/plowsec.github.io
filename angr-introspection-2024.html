<!DOCTYPE html>
<html lang="en">
<head>
	<!-- Basic Metas -->
	<meta charset="utf-8">
	<title>angr for real-world use cases | volodya</title>
	<meta name="description" content="My experiences using angr for real-world use cases in 2024, and extending it to diagnose problems / show what it’s doing">
	<meta name="author" content="plowsec">
	<link rel="author" href=""/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

	<!-- Twitter Cards and Open Graph -->
	<meta name="twitter:card" content="summary">
	<meta name="twitter:creator" content="@volodiyah">
	<meta name="twitter:domain" content="">
	<meta name="twitter:site" content="@volodiyah">
	<meta property="og:title" content="angr for real-world use cases">
	<meta property="og:description" content="My experiences using angr for real-world use cases in 2024, and extending it to diagnose problems / show what it’s doing">
	<meta property="og:image" content="/images/icons/avatar.png">
	<meta property="og:type" content="article">
	<meta property="og:url" content="/angr-introspection-2024.html">

	<!-- Stylesheets and Web Fonts -->
	<link href="/theme/style.min.css?d673191b" rel="stylesheet">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

	<!-- Favicons -->
	<link rel="apple-touch-icon" sizes="180x180" href="/images/icons/apple-touch-icon.png">
	<link rel="icon" type="image/png" href="/images/icons/favicon-16x16.png" sizes="16x16">
	<link rel="icon" type="image/png" href="/images/icons/favicon-32x32.png" sizes="32x32">
	<meta name="theme-color" content="#FF8000">
	<meta name="google-site-verification" content="9iiuP1IGbCXy85riRmrFC_68Vh3CldZM2tvAfxyuXT0" />
	<meta name="msapplication-TileColor" content="#FF8000">
	<meta name="msapplication-TileImage" content="/images/icons/mstile-144x144.png">
	<meta name="msapplication-square70x70logo" content="/images/icons/mstile-small.png">
	<meta name="msapplication-square150x150logo" content="/images/icons/mstile-medium.png">
	<meta name="msapplication-wide310x150logo" content="/images/icons/mstile-wide.png">
	<meta name="msapplication-square310x310logo" content="/images/icons/mstile-large.png">

	<!--[if lt IE 9]>
	<script src="/theme/js/html5shiv.min.js"></script>
	<script src="/theme/js/respond.min.js"></script>
	<![endif]-->
</head>

<body>
	<div class="container">
		<aside>
			<a href="/"><img id="avatar" alt="Site Avatar" src="/images/icons/avatar.png"></a>
			<div id="name"><a href="/">volodya</a></div>
			<div id="bio">Security Engineer interested in Program Analysis, (de)obfuscation and antivirus engines. Stripped binaries || GTFO.</div>

			<div id="sidebar-links">
				<a href="/about/">About</a>
			</div>

			<div id="social">
				<a href="mailto:united.marshmallow(at)gmail.com" title="Email (united.marshmallow(at)gmail.com)" class="icon fa fa-envelope"></a>
				<a href="https://twitter.com/volodiyah" title="Twitter" class="icon fa fa-twitter"></a>
				<a href="https://github.com/plowsec" title="GitHub" class="icon fa fa-github"></a>
			</div>

			<hr id="sidebar-divider">
		</aside>

		<article>
	<h1 class="title"><a href="/angr-introspection-2024.html" title="Permalink to angr for real-world use cases">angr for real-world use&nbsp;cases</a></h1>
	<time class="date" datetime="2024-06-30 00:00:00+02:00">Sun 30 June 2024</time>
	<div class="content">
		<div class="toc"><span class="toctitle">Table of contents:</span><ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#angr-for-real-world-use-cases">angr for real-world use&nbsp;cases</a></li>
<li><a href="#use-pycharm">Use Pycharm</a><ul>
<li><a href="#debugger">Debugger</a></li>
<li><a href="#conditional-breakpoints">Conditional&nbsp;breakpoints</a></li>
<li><a href="#custom-data-renderer">Custom Data&nbsp;Renderer</a></li>
</ul>
</li>
<li><a href="#using-pickle">Using&nbsp;pickle</a></li>
<li><a href="#introspection">Introspection</a><ul>
<li><a href="#coverage-basic-attempt">Coverage: basic&nbsp;attempt</a></li>
<li><a href="#callstack">Callstack</a></li>
<li><a href="#windows-debugging-symbols">Windows Debugging&nbsp;Symbols</a></li>
<li><a href="#handle-errored-states">Handle errored&nbsp;states:</a></li>
<li><a href="#real-time-code-coverage-with-trends">Real-time code coverage with&nbsp;trends</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<h1 id="introduction">Introduction</h1>
<p><code>angr</code> is a project that deeply fascinates me. I tried learning it in 2019, then re-tried one year later in 2020. Then I followed Rolf Rolles <span class="caps">SMT</span>-Based Binary Analysis training which literally unlocked something in my brain. However, I was still stuck at the same old problem: why is <code>angr</code> running for so long and eating all my <span class="caps">RAM</span>?</p>
<p>At the time, I lacked the skills to properly debug it / ingest its source code. However, years later, I&#8217;m not feeling those obstacles anymore. This is probably due to the fact I&#8217;ve done way harder and painful things in between, so <code>angr</code> source code would not scare me this&nbsp;time!</p>
<p>Well, fake news. Experimenting with <code>ioctlance</code> in a Windows Driver, I discovered <code>angr</code> was stuck <em>3 function calls deep</em> after the entry point I gave it. I minimized the test case and asked a colleague for help. We dug at it for 2 hours, and those 2 hours finally helped me overcome the last mental limits I had with <code>angr</code>.</p>
<p>My colleague was quite experimented with <code>angr</code> and insisted on going step by step with the exploration, checking constraints each time with <code>state.solver.constraints</code>. Then, we found that after a call to <code>memmove</code>, that was hooked by a <code>ioctlance</code> <code>SimProcedure</code>, an <code>unsat</code> constraint was&nbsp;added. </p>
<p>My buffer&#8217;s address was <code>0xfffffffff</code> and the Windows driver was doing some kind of overflow check on this address, and did not accept it. Weird! The hook&#8217;s implementation looked totally normal to us. It sure didn&#8217;t return this rather weird&nbsp;value.</p>
<p>My colleague ran out of helping time budget and I continued by myself for 1 hour, using <code>Pycharm</code> debugger to pinpoint when and why this address appeared. Then I found the&nbsp;culprint:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">store</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Fast path</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">int</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store_one_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store_one_addr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">addr</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">symbolic</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">AVOID_MULTIVALUED_WRITES</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
            <span class="c1"># not completed</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">concrete_addrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interleave_ints</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">concretize_write_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">)))</span>
        <span class="k">except</span> <span class="n">SimMemoryError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">options</span><span class="o">.</span><span class="n">CONSERVATIVE_WRITE_STRATEGY</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">options</span><span class="p">:</span>
                <span class="k">return</span>  <span class="c1"># not completed</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="c1"># quick optimization so as to not involve the solver if not necessary</span>
        <span class="n">trivial</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">concrete_addrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="n">concrete_addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">is_true</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">trivial</span><span class="p">:</span>
            <span class="c1"># apply the concretization results to the state</span>
            <span class="n">constraint_options</span> <span class="o">=</span> <span class="p">[</span><span class="n">addr</span> <span class="o">==</span> <span class="n">concrete_addr</span> <span class="k">for</span> <span class="n">concrete_addr</span> <span class="ow">in</span> <span class="n">concrete_addrs</span><span class="p">]</span>
            <span class="n">conditional_constraint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">Or</span><span class="p">(</span><span class="o">*</span><span class="n">constraint_options</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_constraints</span><span class="p">(</span><span class="n">conditional_constraint</span><span class="p">,</span> <span class="n">condition</span><span class="o">=</span><span class="n">condition</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">concrete_addrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># simple case: avoid conditional write since the address has been concretized to one solution</span>
                <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">concrete_addrs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="k">for</span> <span class="n">concrete_addr</span> <span class="ow">in</span> <span class="n">concrete_addrs</span><span class="p">:</span>
            <span class="c1"># perform each of the stores as conditional</span>
            <span class="c1"># the implementation of conditionality must be at the bottom of the stack</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_store_one_addr</span><span class="p">(</span><span class="n">concrete_addr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">trivial</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>

<p><code>angr</code> needed a <code>concrete</code> address (read: a real-looking address) to store the result of <code>memmove</code>, but the hook provided an unconstrained symbolic one (read: like <code>x</code> in algebra). <a href="https://github.com/angr/angr/issues/1993#issuecomment-597999852">This issue</a> is somewhat&nbsp;related:</p>
<blockquote>
<p>That&#8217;s not a bug, that&#8217;s the best angr can do. What do you expect the result of loading from an unconstrained pointer to be? We have to concretize it in order to be able to continue execution.&nbsp;rhelmot</p>
</blockquote>
<p>The rhetoric question from <code>rhelmot</code> sounds smart indeed but newbs like me didn&#8217;t even think about it before running into the&nbsp;problem.</p>
<p>So the fix was simple, I used the <code>strcpy</code> <code>SimProcedure</code> already available in <code>angr</code> and then it all went very well. I&#8217;m telling this anectote for 2&nbsp;reasons:</p>
<ul>
<li>Persistence is&nbsp;key</li>
<li>Useful to show case my worflow when leveraging &#8220;blackbox&#8221;&nbsp;tools.</li>
</ul>
<h1 id="angr-for-real-world-use-cases">angr for real-world use&nbsp;cases</h1>
<p>At this point, I was convinced <code>angr</code><span class="quo">&#8216;</span>s problems were fixable with effort and a methodological approach. Duh&#8230;but research has a psychological factor and you must believe in yourself to sink even more time and effort when nothing has payed off so far. And now I have that in my mind. What&#8217;s&nbsp;next?</p>
<ul>
<li>Understanding what the heck <code>angr</code> is&nbsp;doing.</li>
<li>Finding a solution to &#8220;resume&#8221; <code>angr</code><span class="quo">&#8216;</span>s analysis: it takes 5 minutes for it to find my target address, and I dislike waiting 5 minutes each time I run my&nbsp;script.</li>
<li>Learning how to properly use <code>angr</code> when the documentation is not&nbsp;enough.</li>
</ul>
<p>Let&#8217;s tackle the 3rd problem&nbsp;first.</p>
<h1 id="use-pycharm">Use&nbsp;Pycharm</h1>
<p>Modern IDEs are a must. Honestly I don&#8217;t understand those working on big projects with Vim. It&#8217;s lack coding with your hands tied behind your back. With <code>angr</code>, the documentation does not cover enough information if you&#8217;re looking for a specific use case, so you have two (non-exclusive)&nbsp;options:</p>
<ol>
<li>Reading the source&nbsp;code</li>
<li>Playing with the object attributes and see what they&nbsp;contain.</li>
</ol>
<h2 id="debugger">Debugger</h2>
<p>With <code>Vim</code> and <code>IPython</code>, you would typically alternate between a bunch of <code>print(obj)</code> and <code>dir(obj)</code>. Pycharm shows all of these for&nbsp;you:</p>
<p><a href="/images/pycharm_debugger1.png" title="Pycharm's debugger"><img alt="Pycharm's debugger" src="/images/pycharm_debugger1.png" width="600px"></a></p>
<p>Well it doesn&#8217;t show the methods sadly but having this feature is still quite&nbsp;nice.</p>
<p>There is also source code annotation available with runtime debug information when the debugger hit a&nbsp;breakpoint:</p>
<p><a href="/images/pycharm_debugger2.png" title="Pycharm's source code annotations"><img alt="Pycharm's source code annotations" src="/images/pycharm_debugger2.png" width="600px"></a></p>
<p>Last but not least, <code>PyCharm</code> allows you to select any frame in the callstack and see the past values of local variables. This can help to find how and when that nasty value appeared for the first&nbsp;time:</p>
<p><a href="/images/frames_debugger.png" title="Pycharm's callstack"><img alt="Pycharm's callstack" src="/images/frames_debugger.png" width="600px"></a></p>
<h2 id="conditional-breakpoints">Conditional&nbsp;breakpoints</h2>
<p>What if you&#8217;re aware that a bug happens only when specific conditions are met, or after many iterations of a loop, or after 5 minutes of execution time? You can of course be really patient and use manual steps and / or <code>print</code> statements, but the right tool for that is conditional breakpoints. Here are real examples of breakpoints I set for a debugging&nbsp;session:</p>
<p><a href="/images/conditional_breakpoints.png" title="Pycharm's  conditional breakpoints"><img alt="Pycharm's conditional breakpoints" src="/images/conditional_breakpoints.png" width="600px"></a></p>
<h2 id="custom-data-renderer">Custom Data&nbsp;Renderer</h2>
<p><code>PyCharm</code> provides a way to customize the way data is shown in the debugger. For <code>angr</code>, I find myself often reading hexadecimal addresses and jumping back and forth between <code>angr</code> and <code>IDA Pro</code>. When <code>PyCharm</code> shows me addresses in base 10, I don&#8217;t recognize them anymore and doing <code>print(hex(x))</code> is only fun the first 10,000&nbsp;times:</p>
<p><a href="/images/data_renderer1.png" title="Pycharm's Data Renderer"><img alt="Pycharm's Data Renderer" src="/images/data_renderer1.png" width="600px"></a></p>
<p>And the same for <code>dict</code>:</p>
<p><a href="/images/data_renderer2.png" title="Pycharm's Data Renderer"><img alt="Pycharm's Data Renderer" src="/images/data_renderer2.png" width="600px"></a></p>
<p>The code in the second screenshot is (thanks <code>Claude 3.5</code>):</p>
<div class="codehilite"><pre><span></span><code><span class="p">{(</span><span class="nb">hex</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span><span class="p">):</span> <span class="p">(</span><span class="nb">hex</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="k">else</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
</code></pre></div>

<h1 id="using-pickle">Using&nbsp;pickle</h1>
<p>I&#8217;ve known <code>pickle</code> for a while because I used it heavily in my trading bot. Thus, I know how painful it is to make <span class="caps">ALL</span> your classes serializable, and assumed <code>angr</code> was too complex to be pickl-able. I was&nbsp;wrong!</p>
<p>From the <a href="https://docs.angr.io/en/latest/faq.html">documentation</a>:</p>
<blockquote>
<p>How do I serialize angr objects?
Pickle will work. However, Python will default to using an extremely old pickle protocol that does not support more complex Python data structures, so you must specify a more advanced data stream format. The easiest way to do this is <code>pickle.dumps(obj, -1)</code>.</p>
</blockquote>
<p>What this means is you can pickle the following&nbsp;things:</p>
<ol>
<li><code>angr.Project</code></li>
<li><code>angr.analyses.CFGEmulated</code></li>
<li>The Simulation Manager after a succesful but time consuming <code>.explore</code> call!</li>
</ol>
<p>By doing this, you can resume your <code>angr</code> script and thuse iterate rapidly on the trial-error process that, in my opinion, is primordial to learn something new and build&nbsp;something.</p>
<h1 id="introspection">Introspection</h1>
<p>Let&#8217;s get to the core of this article. With any long-running job, we, developers, require confidence that the executed program is working and not wasting <span class="caps">CPU</span> cycles because of a problem. How to diagnose those? Well, recently I&#8217;m fond of the <code>logging</code> anti-pattern: I log everything to a file so that I can, at a glance, understand if something went&nbsp;sideways.</p>
<p>But here we can go further than&nbsp;this. </p>
<h2 id="coverage-basic-attempt">Coverage: basic&nbsp;attempt</h2>
<p>In fuzzing, we can use code coverage and <code>lighthouse</code> to visualize the fuzzer&#8217;s exploration (and maybe identify bottlenecks). Can we do that with <code>angr</code>?</p>
<p>Sure, as shown by Jannis Kirschner at <a href="https://youtu.be/gudLFiK0x5I?feature=shared&amp;t=1617">Insomni&#8217;hack 2022</a>:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_small_coverage</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">sm</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">stashes</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">stashes</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">simstate</span> <span class="ow">in</span> <span class="n">stashes</span><span class="p">[</span><span class="s2">&quot;active&quot;</span><span class="p">]:</span>
        <span class="n">state_history</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">simstate</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">bbl_addrs</span><span class="o">.</span><span class="n">hardcopy</span><span class="p">:</span>
            <span class="n">write_address</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
            <span class="n">state_history</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">write_address</span><span class="p">)</span>
        <span class="n">raw_syminput</span> <span class="o">=</span> <span class="n">simstate</span><span class="o">.</span><span class="n">posix</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">posix</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>

        <span class="n">syminput</span> <span class="o">=</span> <span class="n">simstate</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">raw_syminput</span><span class="p">,</span> <span class="n">cast_to</span><span class="o">=</span><span class="nb">bytes</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">syminput</span><span class="p">)</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">simstate</span><span class="o">.</span><span class="n">ip</span><span class="p">))</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">sid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_active_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">_</span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sid</span><span class="p">,</span> <span class="n">syminput</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">uid</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">state_history</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">simgr</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span><span class="n">find</span><span class="o">=</span><span class="mh">0x00001407</span><span class="p">,</span> <span class="n">step_func</span><span class="o">=</span><span class="n">get_small_coverage</span><span class="p">)</span>
</code></pre></div>

<p>Here, I used ChatGPT as an <span class="caps">OCR</span> tool to transcribe the slide shown in the YouTube Video (I know ChatGPT uses <a href="https://pypi.org/project/pytesseract/">pytesseract</a> behind the scenes, but the output is a lot&nbsp;better).</p>
<p>Running this <a href="https://docs.angr.io/en/latest/advanced-topics/pipeline.html#step">step_func</a> creates a bunch of files in the local folder as <code>angr</code> progresses towards the goal given to&nbsp;it:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>-lsaht<span class="w"> </span><span class="p">|</span><span class="w"> </span>head
total<span class="w"> </span><span class="m">74912</span>
<span class="w"> </span><span class="m">0</span><span class="w"> </span>drwxr-xr-x<span class="w">    </span><span class="m">38</span><span class="w"> </span>user<span class="w">  </span>staff<span class="w">   </span><span class="m">1</span>.2K<span class="w"> </span>Jun<span class="w"> </span><span class="m">14</span><span class="w"> </span><span class="m">14</span>:34<span class="w"> </span>..
<span class="w"> </span><span class="m">0</span><span class="w"> </span>drwxr-xr-x<span class="w">  </span><span class="m">5416</span><span class="w"> </span>user<span class="w">  </span>staff<span class="w">   </span>169K<span class="w"> </span>Jun<span class="w"> </span><span class="m">13</span><span class="w"> </span><span class="m">15</span>:35<span class="w"> </span>.
<span class="m">16</span><span class="w"> </span>-rw-r--r--<span class="w">     </span><span class="m">1</span><span class="w"> </span>user<span class="w">  </span>staff<span class="w">   </span><span class="m">7</span>.9K<span class="w"> </span>Jun<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">16</span>:13<span class="w"> </span>00164_active_0x1c0010ae4_d9d59da2-daf1-43b3-999a-02d85f814778
<span class="m">16</span><span class="w"> </span>-rw-r--r--<span class="w">     </span><span class="m">1</span><span class="w"> </span>user<span class="w">  </span>staff<span class="w">   </span><span class="m">7</span>.9K<span class="w"> </span>Jun<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">16</span>:13<span class="w"> </span>00163_active_0x1c0010ae6_b9618c9b-6c05-4c2d-8ba1-6a9b74dbdcb5
<span class="m">16</span><span class="w"> </span>-rw-r--r--<span class="w">     </span><span class="m">1</span><span class="w"> </span>user<span class="w">  </span>staff<span class="w">   </span><span class="m">7</span>.9K<span class="w"> </span>Jun<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">16</span>:13<span class="w"> </span>00162_active_0x1c0010b98_81b30e77-01ad-43c0-8990-c58877d738d2
<span class="m">16</span><span class="w"> </span>-rw-r--r--<span class="w">     </span><span class="m">1</span><span class="w"> </span>user<span class="w">  </span>staff<span class="w">   </span><span class="m">7</span>.9K<span class="w"> </span>Jun<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">16</span>:13<span class="w"> </span>00161_active_0x1c0010b9d_18a2bf38-1aa1-47c5-a206-2cc116ab5486
<span class="m">16</span><span class="w"> </span>-rw-r--r--<span class="w">     </span><span class="m">1</span><span class="w"> </span>user<span class="w">  </span>staff<span class="w">   </span><span class="m">7</span>.9K<span class="w"> </span>Jun<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">16</span>:13<span class="w"> </span>00160_active_0x1c0010baf_788b6aae-a9f2-4866-9458-7c28c0bf3390
<span class="m">16</span><span class="w"> </span>-rw-r--r--<span class="w">     </span><span class="m">1</span><span class="w"> </span>user<span class="w">  </span>staff<span class="w">   </span><span class="m">7</span>.9K<span class="w"> </span>Jun<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">16</span>:13<span class="w"> </span>00159_active_0x1c0010bb7_96548594-619a-4a2e-8445-072c208ec02a
<span class="m">16</span><span class="w"> </span>-rw-r--r--<span class="w">     </span><span class="m">1</span><span class="w"> </span>user<span class="w">  </span>staff<span class="w">   </span><span class="m">7</span>.9K<span class="w"> </span>Jun<span class="w">  </span><span class="m">6</span><span class="w"> </span><span class="m">16</span>:13<span class="w"> </span>00158_active_0x1c01000e0_f1177956-e9e4-4c8f-8ab3-a87e4c9821a9
</code></pre></div>

<p>And reading one of these&nbsp;shows:</p>
<div class="codehilite"><pre><span></span><code>$<span class="w"> </span>cat<span class="w"> </span>00164_active_0x1c0010ae4_d9d59da2-daf1-43b3-999a-02d85f814778<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w">                                                                                       </span>
0x1c00109e8
0x1c0010a1b
0x1c0010a36
0x1c0010b4c
0x1c0010b88
0x1c002fc30
0x1c0100298
0x1c002fc3b
0x1c0010b8d
0x1c0010b5f
</code></pre></div>

<p>Then we can load all these files using <a href="https://github.com/gaasedelen/lighthouse">Lighthouse</a>: <code>IDA Pro &gt; Load File &gt; Code Coverage batch</code>:</p>
<p><a href="/images/coverage_lighthouse.png" title="Code coverage with angr"><img alt="Code coverage with angr" src="/images/coverage_lighthouse.png" width="600px"></a></p>
<p>This is quite&nbsp;nice!</p>
<h2 id="callstack">Callstack</h2>
<p>Another useful tool in our toolbox is the ability to know where <code>angr</code> currently is and how it got there. The documentation states that we should use <code>state.history.descriptions.hardcopy</code> and <code>state.history.events</code>. Let&#8217;s try&nbsp;those:</p>
<div class="codehilite"><pre><span></span><code><span class="n">f</span> <span class="o">=</span> <span class="n">simgr</span><span class="o">.</span><span class="n">one_found</span>
<span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">descriptions</span><span class="o">.</span><span class="n">hardcopy</span><span class="p">)</span>
<span class="p">[</span><span class="s1">&#39;&lt;IRSB from 0x140001200: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;SimProcedure HookVPrintf from 0x140001550: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x140001238: 2 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x1400012f8: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;SimProcedure HookVPrintf from 0x140001550: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x140001304: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x140001040: 1 sat 1 unsat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x1400011b0: 1 sat 1 unsat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x1400011b9: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;SimProcedure MallocHook from 0x140100050: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x1400011c2: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;SimProcedure HookVPrintf from 0x140001550: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x1400011e5: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x140001311: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x140001040: 1 sat 1 unsat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x140001056: 1 sat 1 unsat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x14000112d: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;SimProcedure HookVPrintf from 0x140001550: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x14000113c: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x14000131b: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x140001000: 1 sat 1 unsat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x140001034: 1 sat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x14000132c: 1 sat 1 unsat&gt;&#39;</span><span class="p">,</span>
 <span class="s1">&#39;&lt;IRSB from 0x14000133a: 1 sat 1 unsat&gt;&#39;</span><span class="p">]</span>
<span class="n">f</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">events</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">angr</span><span class="o">.</span><span class="n">state_plugins</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">LambdaIterIter</span> <span class="n">at</span> <span class="mh">0x310f73350</span><span class="o">&gt;</span>
<span class="nb">list</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">events</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span> 
<span class="p">[</span><span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">operations_2419_96</span><span class="p">[</span><span class="mi">95</span><span class="p">:</span><span class="mi">64</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x0</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">operations_2419_96</span><span class="p">[</span><span class="mi">95</span><span class="p">:</span><span class="mi">64</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0x7a6b</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">operations_2419_96</span><span class="p">[</span><span class="mi">63</span><span class="p">:</span><span class="mi">32</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x0</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">operations_2419_96</span><span class="p">[</span><span class="mi">63</span><span class="p">:</span><span class="mi">32</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0x7a6b</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">operations_2419_96</span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x0</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">operations_2419_96</span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0x7a6b</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">values_2420_96</span><span class="p">[</span><span class="mi">95</span><span class="p">:</span><span class="mi">64</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x0</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">values_2420_96</span><span class="p">[</span><span class="mi">95</span><span class="p">:</span><span class="mi">64</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0x9</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">values_2420_96</span><span class="p">[</span><span class="mi">63</span><span class="p">:</span><span class="mi">32</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x0</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">values_2420_96</span><span class="p">[</span><span class="mi">63</span><span class="p">:</span><span class="mi">32</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0x9</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">values_2420_96</span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x0</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">values_2420_96</span><span class="p">[</span><span class="mi">31</span><span class="p">:</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mh">0x9</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001200</span><span class="p">:</span><span class="mi">0</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">operations_2419_96</span><span class="p">[</span><span class="mi">95</span><span class="p">:</span><span class="mi">64</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7a6b</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11890</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11891</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11892</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11893</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11894</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11895</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11896</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">fs_write</span> <span class="mi">11897</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pos</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x14000123f</span><span class="p">:</span><span class="mi">23</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">mem_100000_2428_32</span><span class="p">{</span><span class="n">UNINITIALIZED</span><span class="p">}</span> <span class="o">!=</span> <span class="mh">0x7a69</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001289</span><span class="p">:</span><span class="mi">18</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">mem_100000_2428_32</span><span class="p">{</span><span class="n">UNINITIALIZED</span><span class="p">}</span> <span class="o">!=</span> <span class="mh">0x7a6a</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x1400012f6</span><span class="p">:</span><span class="mi">18</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">mem_100000_2428_32</span><span class="p">{</span><span class="n">UNINITIALIZED</span><span class="p">}</span> <span class="o">==</span> <span class="mh">0x7a6b</span><span class="o">&gt;&gt;&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">fs_write</span> <span class="mi">11906</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pos</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11933</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11934</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">fs_write</span> <span class="mi">11935</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pos</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11938</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">unconstrained</span> <span class="mi">11967</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">name</span><span class="p">,</span> <span class="n">bits</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimEvent</span> <span class="n">fs_write</span> <span class="mi">11968</span><span class="p">,</span> <span class="k">with</span> <span class="n">fields</span> <span class="n">filename</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">pos</span><span class="o">&gt;</span><span class="p">,</span>
 <span class="o">&lt;</span><span class="n">SimActionConstraint</span> <span class="mh">0x140001007</span><span class="p">:</span><span class="mi">22</span> <span class="o">&lt;</span><span class="n">SAO</span> <span class="o">&lt;</span><span class="n">Bool</span> <span class="n">mem_100000_2428_32</span><span class="p">{</span><span class="n">UNINITIALIZED</span><span class="p">}</span> <span class="o">!=</span> <span class="mh">0x1</span><span class="o">&gt;&gt;&gt;</span><span class="p">]</span>
</code></pre></div>

<p>Okay, there is a lot of information in there, but I find it hard to read and we&#8217;re losing an important information because the callstack is &#8220;flattened&#8221; (probably not the right word but I&#8217;m going with&nbsp;it).</p>
<p>Given these shortcomings, I implemented a simple function that prints some kind of annotated backtrace for an <code>angr</code> state, using indentation to display the control&nbsp;flow:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">pretty_print_callstack</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">SimState</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Print a formatted call stack for a given state.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: The simulation state.</span>
<span class="sd">        max_depth: Maximum depth of the call stack to print.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">state_history</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Call Stack:</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">kb_functions</span> <span class="o">=</span> <span class="n">shared</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">functions</span>

    <span class="n">last_addr</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">repeat_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">formatted_lines</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">call_stack</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">angr</span><span class="o">.</span><span class="n">knowledge_plugins</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">Function</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_func</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">knowledge_plugins</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">Function</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">addr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">history</span><span class="o">.</span><span class="n">bbl_addrs</span><span class="o">.</span><span class="n">hardcopy</span><span class="p">):</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">knowledge_plugins</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">kb_functions</span><span class="o">.</span><span class="n">floor_func</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">addr</span> <span class="o">==</span> <span class="n">last_addr</span><span class="p">:</span>
            <span class="n">repeat_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">repeat_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">formatted_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (repeated </span><span class="si">{</span><span class="n">repeat_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> times)&quot;</span>
                <span class="n">repeat_count</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">func</span> <span class="o">!=</span> <span class="n">current_func</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">call_stack</span><span class="p">:</span>
                    <span class="k">while</span> <span class="n">call_stack</span> <span class="ow">and</span> <span class="n">call_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">func</span><span class="p">:</span>
                        <span class="n">call_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">call_stack</span><span class="p">:</span>
                        <span class="n">call_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">call_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                <span class="n">current_func</span> <span class="o">=</span> <span class="n">func</span>

            <span class="n">indent</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">call_stack</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
                <span class="n">fname</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">human_str</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;human_str&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">func</span><span class="o">.</span><span class="n">name</span>
                <span class="n">func_prototype</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">prototype</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;prototype&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
                <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">-&gt; 0x</span><span class="si">{</span><span class="n">addr</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">fname</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">func_prototype</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">xrefs</span><span class="p">))</span><span class="si">}</span><span class="s2"> xrefs)&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">formatted_lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">indent</span><span class="si">}</span><span class="s2">-&gt; 0x</span><span class="si">{</span><span class="n">addr</span><span class="si">:</span><span class="s2">x</span><span class="si">}</span><span class="s2"> : Unknown function&quot;</span><span class="p">)</span>

        <span class="n">last_addr</span> <span class="o">=</span> <span class="n">addr</span>

    <span class="k">if</span> <span class="n">repeat_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">formatted_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; (repeated </span><span class="si">{</span><span class="n">repeat_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> times)&quot;</span>

    <span class="n">state_history</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_lines</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">formatted_lines</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_depth</span> <span class="o">+</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">state_history</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">formatted_lines</span><span class="p">[:</span><span class="n">max_depth</span><span class="p">]))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;...(truncated </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">formatted_lines</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">max_depth</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="si">}</span><span class="s2"> lines)&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">state_history</span><span class="p">)</span>
</code></pre></div>

<p>This&nbsp;displays:</p>
<div class="codehilite"><pre><span></span><code>Active<span class="w"> </span>state:<span class="w"> </span>&lt;SimState<span class="w"> </span>@<span class="w"> </span>0x1400010f0&gt;
<span class="m">2024</span>-06-30<span class="w"> </span><span class="m">13</span>:39:57<span class="w"> </span><span class="p">|</span><span class="w"> </span>DEBUG<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">[</span>introspection.py:113<span class="o">]</span><span class="w"> </span>pretty_print_callstack<span class="o">()</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Call<span class="w"> </span>Stack:
<span class="w">  </span>-&gt;<span class="w"> </span>0x140001200<span class="w"> </span>:<span class="w"> </span>sub_140001200<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">    </span>-&gt;<span class="w"> </span>0x140001550<span class="w"> </span>:<span class="w"> </span>sub_140001550<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001238<span class="w"> </span>:<span class="w"> </span>sub_140001200<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001284<span class="w"> </span>:<span class="w"> </span>sub_140001200<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400012f1<span class="w"> </span>:<span class="w"> </span>sub_140001200<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400012f8<span class="w"> </span>:<span class="w"> </span>sub_140001200<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">  </span>-&gt;<span class="w"> </span>0x140001550<span class="w"> </span>:<span class="w"> </span>sub_140001550<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">    </span>-&gt;<span class="w"> </span>0x140001304<span class="w"> </span>:<span class="w"> </span>sub_140001200<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">      </span>-&gt;<span class="w"> </span>0x140001040<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">      </span>-&gt;<span class="w"> </span>0x1400011b0<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">      </span>-&gt;<span class="w"> </span>0x1400011b9<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">        </span>-&gt;<span class="w"> </span>0x140100050<span class="w"> </span>:<span class="w"> </span>malloc<span class="w"> </span><span class="o">(</span>unsigned<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void*<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">    </span>-&gt;<span class="w"> </span>0x1400011c2<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001550<span class="w"> </span>:<span class="w"> </span>sub_140001550<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">  </span>-&gt;<span class="w"> </span>0x1400011e5<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">    </span>-&gt;<span class="w"> </span>0x140001311<span class="w"> </span>:<span class="w"> </span>sub_140001200<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001040<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001056<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001060<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x14000106a<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400010b9<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400010c5<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400010d9<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400010f0<span class="w"> </span>:<span class="w"> </span>sub_140001040<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span><span class="w"> </span><span class="o">(</span>repeated<span class="w"> </span><span class="m">97</span><span class="w"> </span><span class="nb">times</span><span class="o">)</span>
</code></pre></div>

<p>Notice the last line: <code>repeated 97 times</code>. <code>angr</code> was exploring a loop with 100 iterations. Can be useful to diagnose state&nbsp;explosion!</p>
<p>For now, the callstack lacks some symbols. Unfortunately, <code>angr</code> doesn&#8217;t yet support Windows symbols. Let&#8217;s remedy&nbsp;that.</p>
<h2 id="windows-debugging-symbols">Windows Debugging&nbsp;Symbols</h2>
<p>Windows debugging symbols are available in the form of <code>*.pdb</code> files that live alongside the compiled binary. When it comes to Python libraries that know how to parse <span class="caps">PDB</span> files, we don&#8217;t have much choices. I decided to use <code>pdbparse</code>, which is old and buggy. Examples online did not work for me, so using <code>pycharm's debugger</code> I manually explored all the attributes of a parsed <span class="caps">PDB</span> file and put together the following&nbsp;code:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">load_global_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load global symbols from the PDB.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dict[int, str]: A dictionary mapping offsets to symbol names.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">globals_symbols</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">streams</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s1">&#39;funcs&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">sym_value</span> <span class="ow">in</span> <span class="n">stream</span><span class="o">.</span><span class="n">funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">globals_symbols</span><span class="p">[</span><span class="n">sym_value</span><span class="o">.</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">sym_value</span><span class="o">.</span><span class="n">name</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Global symbol: </span><span class="si">{</span><span class="n">sym_value</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sym_value</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">globals_symbols</span>
</code></pre></div>

<p>Notice I&#8217;m using the <code>offset</code> attribute. This is a <a href="https://stackoverflow.com/questions/2170843/va-virtual-address-rva-relative-virtual-address">Relative Virtual Address (<span class="caps">RVA</span>)</a> and can&#8217;t be used as-is with <code>angr</code>. We have to adjust it first. For Windows binaries, <code>angr</code> seems to give the address <code>loaded base + offset</code> to all functions. The offsets in the <span class="caps">PDB</span> are however offsets to their enclosing <span class="caps">PE</span> section. Knowing that, let&#8217;s put together the following&nbsp;code:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">get_text_section_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the offset of the .text section from the image base.</span>

<span class="sd">    Returns:</span>
<span class="sd">        int: The offset of the .text section, or 0 if not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">main_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">main_object</span>
    <span class="k">for</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">main_object</span><span class="o">.</span><span class="n">sections_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">section_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.text&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">section</span><span class="o">.</span><span class="n">vaddr</span> <span class="o">-</span> <span class="n">main_object</span><span class="o">.</span><span class="n">mapped_base</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not find .text section. Using 0 as offset.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">address_to_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert an address to a symbol name.</span>

<span class="sd">    Args:</span>
<span class="sd">        address (int): The address to look up.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Optional[str]: The symbol name if found, None otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rva</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">address</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">main_object</span><span class="o">.</span><span class="n">mapped_base</span>

    <span class="n">symbol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rva</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">symbol</span>

    <span class="n">adjusted_rva</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">rva</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_section_offset</span>
    <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">adjusted_rva</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">symbol</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symbol not found for address </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s2"> (RVA: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">rva</span><span class="p">)</span><span class="si">}</span><span class="s2">, Adjusted RVA: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">adjusted_rva</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<p>This uses <code>loader.main_object.mapped_base</code> and the <code>.text</code> section offset to adjust all offsets. Note that we assume every symbol will be in the <code>.text</code> section, which is obviously not true, but I don&#8217;t code to make art, I code to solve just enough of the problems I&#8217;m&nbsp;facing.</p>
<p>Then, we can update <code>angr</code><span class="quo">&#8216;</span>s knowledge base with this&nbsp;information:</p>
<div class="codehilite"><pre><span></span><code>    <span class="k">def</span> <span class="nf">update_kb_with_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the knowledge base with symbols.</span>

<span class="sd">        This method updates the names of functions in the angr knowledge base</span>
<span class="sd">        with demangled symbols from the PDB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_to_symbol</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
                <span class="n">demangled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demangle_name</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">func</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">demangled</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2"> updated with symbol: </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>The entire file&nbsp;is:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">angr</span>
<span class="kn">import</span> <span class="nn">pdbparse</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
<span class="kn">from</span> <span class="nn">helpers.log</span> <span class="kn">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">cppmangle</span> <span class="kn">import</span> <span class="n">demangle</span><span class="p">,</span> <span class="n">cdecl_sym</span>

<span class="k">class</span> <span class="nc">SymbolManager</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to manage symbols for an angr project.</span>

<span class="sd">    This class handles loading symbols from PDB files, demangling names,</span>
<span class="sd">    and mapping addresses to symbols.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the SymbolManager.</span>

<span class="sd">        Args:</span>
<span class="sd">            proj (angr.Project): The angr project to analyze.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span> <span class="o">=</span> <span class="n">proj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="p">:</span> <span class="n">pdbparse</span><span class="o">.</span><span class="n">PDB</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_symbols</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_global_symbols</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">text_section_offset</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_text_section_offset</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">load_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pdbparse</span><span class="o">.</span><span class="n">PDB</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load symbols for the angr project from a PDB file.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pdbparse.PDB: The parsed PDB file.</span>

<span class="sd">        Raises:</span>
<span class="sd">            FileNotFoundError: If the PDB file is not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">binary_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">filename</span>
        <span class="n">pdb_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">binary_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.pdb&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pdb_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;PDB file not found: </span><span class="si">{</span><span class="n">pdb_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pdbparse</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">pdb_path</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_global_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load global symbols from the PDB.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dict[int, str]: A dictionary mapping offsets to symbol names.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">globals_symbols</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">stream</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdb</span><span class="o">.</span><span class="n">streams</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="s1">&#39;funcs&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">sym</span><span class="p">,</span> <span class="n">sym_value</span> <span class="ow">in</span> <span class="n">stream</span><span class="o">.</span><span class="n">funcs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">globals_symbols</span><span class="p">[</span><span class="n">sym_value</span><span class="o">.</span><span class="n">offset</span><span class="p">]</span> <span class="o">=</span> <span class="n">sym_value</span><span class="o">.</span><span class="n">name</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Global symbol: </span><span class="si">{</span><span class="n">sym_value</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">sym_value</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">globals_symbols</span>

    <span class="k">def</span> <span class="nf">get_text_section_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the offset of the .text section from the image base.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: The offset of the .text section, or 0 if not found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">main_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">main_object</span>
        <span class="k">for</span> <span class="n">section_name</span><span class="p">,</span> <span class="n">section</span> <span class="ow">in</span> <span class="n">main_object</span><span class="o">.</span><span class="n">sections_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">section_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;.text&#39;</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">section</span><span class="o">.</span><span class="n">vaddr</span> <span class="o">-</span> <span class="n">main_object</span><span class="o">.</span><span class="n">mapped_base</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not find .text section. Using 0 as offset.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">demangle_name</span><span class="p">(</span><span class="n">mangled_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Demangle a C++ function name and extract just the function name.</span>

<span class="sd">        Args:</span>
<span class="sd">            mangled_name (str): The mangled function name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: The demangled function name without parameters or return type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">full_demangled</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">cdecl_sym</span><span class="p">(</span><span class="n">demangle</span><span class="p">(</span><span class="n">mangled_name</span><span class="p">))</span>
            <span class="n">match</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">Match</span><span class="p">]</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(?:.*::)?(\w+)\(&#39;</span><span class="p">,</span> <span class="n">full_demangled</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">match</span> <span class="k">else</span> <span class="n">full_demangled</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">mangled_name</span>

    <span class="k">def</span> <span class="nf">address_to_symbol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">address</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an address to a symbol name.</span>

<span class="sd">        Args:</span>
<span class="sd">            address (int): The address to look up.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Optional[str]: The symbol name if found, None otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rva</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">address</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">main_object</span><span class="o">.</span><span class="n">mapped_base</span>

        <span class="n">symbol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">rva</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">symbol</span>

        <span class="n">adjusted_rva</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">rva</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">text_section_offset</span>
        <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbols</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">adjusted_rva</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">symbol</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Symbol not found for address </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="si">}</span><span class="s2"> (RVA: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">rva</span><span class="p">)</span><span class="si">}</span><span class="s2">, Adjusted RVA: </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">adjusted_rva</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">update_kb_with_symbols</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the knowledge base with symbols.</span>

<span class="sd">        This method updates the names of functions in the angr knowledge base</span>
<span class="sd">        with demangled symbols from the PDB.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">symbol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">address_to_symbol</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">symbol</span><span class="p">:</span>
                <span class="n">demangled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">demangle_name</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">func</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">demangled</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span><span class="si">}</span><span class="s2"> updated with symbol: </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>And can be used like&nbsp;this:</p>
<div class="codehilite"><pre><span></span><code><span class="n">symbol_manager</span> <span class="o">=</span> <span class="n">symbols</span><span class="o">.</span><span class="n">SymbolManager</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span> <span class="c1"># angr.Project</span>
<span class="n">symbol_manager</span><span class="o">.</span><span class="n">update_kb_with_symbols</span><span class="p">()</span>
</code></pre></div>

<p>The same information displayed before now shows proper function&nbsp;names:</p>
<div class="codehilite"><pre><span></span><code>Active<span class="w"> </span>state:<span class="w"> </span>&lt;SimState<span class="w"> </span>@<span class="w"> </span>0x1400010f0&gt;
<span class="m">2024</span>-06-30<span class="w"> </span><span class="m">13</span>:56:35<span class="w"> </span><span class="p">|</span><span class="w"> </span>DEBUG<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="o">[</span>introspection.py:113<span class="o">]</span><span class="w"> </span>pretty_print_callstack<span class="o">()</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>Call<span class="w"> </span>Stack:
<span class="w">  </span>-&gt;<span class="w"> </span>0x140001200<span class="w"> </span>:<span class="w"> </span>run_heap_operations<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">    </span>-&gt;<span class="w"> </span>0x140001550<span class="w"> </span>:<span class="w"> </span><span class="nb">printf</span><span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001238<span class="w"> </span>:<span class="w"> </span>run_heap_operations<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001284<span class="w"> </span>:<span class="w"> </span>run_heap_operations<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400012f1<span class="w"> </span>:<span class="w"> </span>run_heap_operations<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400012f8<span class="w"> </span>:<span class="w"> </span>run_heap_operations<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">  </span>-&gt;<span class="w"> </span>0x140001550<span class="w"> </span>:<span class="w"> </span><span class="nb">printf</span><span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">    </span>-&gt;<span class="w"> </span>0x140001304<span class="w"> </span>:<span class="w"> </span>run_heap_operations<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">      </span>-&gt;<span class="w"> </span>0x140001040<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">      </span>-&gt;<span class="w"> </span>0x1400011b0<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">      </span>-&gt;<span class="w"> </span>0x1400011b9<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">        </span>-&gt;<span class="w"> </span>0x140100050<span class="w"> </span>:<span class="w"> </span>malloc<span class="w"> </span><span class="o">(</span>unsigned<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void*<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">    </span>-&gt;<span class="w"> </span>0x1400011c2<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001550<span class="w"> </span>:<span class="w"> </span><span class="nb">printf</span><span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">  </span>-&gt;<span class="w"> </span>0x1400011e5<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
<span class="w">    </span>-&gt;<span class="w"> </span>0x140001311<span class="w"> </span>:<span class="w"> </span>run_heap_operations<span class="w"> </span>None<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001040<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001056<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x140001060<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x14000106a<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400010b9<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400010c5<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400010d9<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span>
-&gt;<span class="w"> </span>0x1400010f0<span class="w"> </span>:<span class="w"> </span>do_heap_op<span class="w"> </span><span class="o">(</span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">)</span>,<span class="w"> </span>long<span class="w"> </span>long<span class="w"> </span><span class="o">(</span><span class="m">64</span><span class="w"> </span>bits<span class="o">))</span><span class="w"> </span>-&gt;<span class="w"> </span>void<span class="w"> </span><span class="o">(</span><span class="m">0</span><span class="w"> </span>xrefs<span class="o">)</span><span class="w"> </span><span class="o">(</span>repeated<span class="w"> </span><span class="m">97</span><span class="w"> </span><span class="nb">times</span><span class="o">)</span>
</code></pre></div>

<h2 id="handle-errored-states">Handle errored&nbsp;states:</h2>
<p>I made this simple helper function to print a Python&nbsp;backtrace:</p>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">show_errors</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">SimState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Log error information for a given state.</span>

<span class="sd">    Args:</span>
<span class="sd">        state: The simulation state.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;errored state: </span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;error message: </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="n">tb</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">traceback</span>

    <span class="k">while</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_next</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tb</span><span class="o">.</span><span class="n">tb_frame</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">tb</span> <span class="o">=</span> <span class="n">tb</span><span class="o">.</span><span class="n">tb_next</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">tb</span><span class="o">.</span><span class="n">tb_frame</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="real-time-code-coverage-with-trends">Real-time code coverage with&nbsp;trends</h2>
<p>Wouldn&#8217;t it be nice to have a status update every 5 seconds, showing how many blocks were newly discovered by <code>angr</code>, the code coverage progress in percent for each function and a graph showing if <code>angr</code> is slowing&nbsp;down?</p>
<p>Demo&nbsp;time:</p>
<div class="codehilite"><pre><span></span><code>INFO<span class="w">     </span>core.coverage:coverage.py:90<span class="w"> </span>---<span class="w"> </span>Coverage<span class="w"> </span>Update<span class="w"> </span>at<span class="w"> </span><span class="m">0</span>.01<span class="w"> </span>seconds<span class="w"> </span>---
INFO<span class="w">     </span>core.coverage:coverage.py:117<span class="w"> </span>Overall<span class="w"> </span>coverage:<span class="w"> </span><span class="m">0</span>.00%<span class="w"> </span><span class="o">[</span>+0<span class="w"> </span>blocks<span class="w"> </span>total<span class="o">]</span>
INFO<span class="w">     </span>core.coverage:coverage.py:119<span class="w"> </span>Newly<span class="w"> </span>discovered<span class="w"> </span>functions:<span class="w"> </span>sub_140001550,<span class="w"> </span>sub_140001b68,<span class="w"> </span>sub_140001380,<span class="w"> </span>sub_140002070,<span class="w"> </span>UnhandledExceptionFilter,<span class="w"> </span>QueryPerformanceCounter,<span class="w"> </span>free
INFO<span class="w">     </span>core.coverage:coverage.py:90<span class="w"> </span>---<span class="w"> </span>Coverage<span class="w"> </span>Update<span class="w"> </span>at<span class="w"> </span><span class="m">4</span>.10<span class="w"> </span>seconds<span class="w"> </span>---
INFO<span class="w">     </span>core.coverage:coverage.py:112<span class="w"> </span>Function:<span class="w"> </span>sub_140001550<span class="w"> </span>-<span class="w"> </span>Covered<span class="w"> </span>blocks:<span class="w"> </span><span class="m">1</span>/21<span class="w"> </span><span class="o">(</span><span class="m">4</span>.76%<span class="o">)</span><span class="w"> </span><span class="o">[</span>+1<span class="w"> </span>blocks<span class="o">]</span>
INFO<span class="w">     </span>core.coverage:coverage.py:112<span class="w"> </span>Function:<span class="w"> </span>sub_140001040<span class="w"> </span>-<span class="w"> </span>Covered<span class="w"> </span>blocks:<span class="w"> </span><span class="m">20</span>/30<span class="w"> </span><span class="o">(</span><span class="m">66</span>.67%<span class="o">)</span><span class="w"> </span><span class="o">[</span>+20<span class="w"> </span>blocks<span class="o">]</span>
INFO<span class="w">     </span>core.coverage:coverage.py:112<span class="w"> </span>Function:<span class="w"> </span>sub_140001200<span class="w"> </span>-<span class="w"> </span>Covered<span class="w"> </span>blocks:<span class="w"> </span><span class="m">32</span>/35<span class="w"> </span><span class="o">(</span><span class="m">91</span>.43%<span class="o">)</span><span class="w"> </span><span class="o">[</span>+32<span class="w"> </span>blocks<span class="o">]</span>
INFO<span class="w">     </span>core.coverage:coverage.py:112<span class="w"> </span>Function:<span class="w"> </span>sub_140001000<span class="w"> </span>-<span class="w"> </span>Covered<span class="w"> </span>blocks:<span class="w"> </span><span class="m">8</span>/8<span class="w"> </span><span class="o">(</span><span class="m">100</span>.00%<span class="o">)</span><span class="w"> </span><span class="o">[</span>+8<span class="w"> </span>blocks<span class="o">]</span>
INFO<span class="w">     </span>core.coverage:coverage.py:117<span class="w"> </span>Overall<span class="w"> </span>coverage:<span class="w"> </span><span class="m">0</span>.22%<span class="w"> </span><span class="o">[</span>+61<span class="w"> </span>blocks<span class="w"> </span>total<span class="o">]</span>
INFO<span class="w">     </span>core.coverage:coverage.py:90<span class="w"> </span>---<span class="w"> </span>Coverage<span class="w"> </span>Update<span class="w"> </span>at<span class="w"> </span><span class="m">7</span>.78<span class="w"> </span>seconds<span class="w"> </span>---
INFO<span class="w">     </span>core.coverage:coverage.py:112<span class="w"> </span>Function:<span class="w"> </span>sub_140001040<span class="w"> </span>-<span class="w"> </span>Covered<span class="w"> </span>blocks:<span class="w"> </span><span class="m">22</span>/30<span class="w"> </span><span class="o">(</span><span class="m">73</span>.33%<span class="o">)</span><span class="w"> </span><span class="o">[</span>+2<span class="w"> </span>blocks<span class="o">]</span>
INFO<span class="w">     </span>core.coverage:coverage.py:112<span class="w"> </span>Function:<span class="w"> </span>sub_140001200<span class="w"> </span>-<span class="w"> </span>Covered<span class="w"> </span>blocks:<span class="w"> </span><span class="m">33</span>/35<span class="w"> </span><span class="o">(</span><span class="m">94</span>.29%<span class="o">)</span><span class="w"> </span><span class="o">[</span>+1<span class="w"> </span>blocks<span class="o">]</span>
INFO<span class="w">     </span>core.coverage:coverage.py:117<span class="w"> </span>Overall<span class="w"> </span>coverage:<span class="w"> </span><span class="m">0</span>.23%<span class="w"> </span><span class="o">[</span>+3<span class="w"> </span>blocks<span class="w"> </span>total<span class="o">]</span>
INFO<span class="w">     </span>core.coverage:coverage.py:90<span class="w"> </span>---<span class="w"> </span>Coverage<span class="w"> </span>Update<span class="w"> </span>at<span class="w"> </span><span class="m">11</span>.07<span class="w"> </span>seconds<span class="w"> </span>---
INFO<span class="w">     </span>core.coverage:coverage.py:117<span class="w"> </span>Overall<span class="w"> </span>coverage:<span class="w"> </span><span class="m">0</span>.23%<span class="w"> </span><span class="o">[</span>+0<span class="w"> </span>blocks<span class="w"> </span>total<span class="o">]</span>
INFO<span class="w">     </span>core.coverage:coverage.py:90<span class="w"> </span>---<span class="w"> </span>Coverage<span class="w"> </span>Update<span class="w"> </span>at<span class="w"> </span><span class="m">14</span>.33<span class="w"> </span>seconds<span class="w"> </span>---
</code></pre></div>

<p>And a visual&nbsp;graph:</p>
<p><a href="/images/real_time_code_coverage.png" title="Real-time code coverage"><img alt="Real-time code coverage" src="/images/real_time_code_coverage.png" width="600px"></a></p>
<p>The code is a simple class that can be plugged-in right away in your <code>angr</code> project:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span>
<span class="kn">import</span> <span class="nn">angr</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;matplotlib&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CoverageMonitor</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">analyses</span><span class="o">.</span><span class="n">CFGEmulated</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">update_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span> <span class="n">coverage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cov&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the CoverageMonitor.</span>

<span class="sd">        :param proj: The Angr project</span>
<span class="sd">        :param cfg: The Control Flow Graph</span>
<span class="sd">        :param entry_point: The entry point address</span>
<span class="sd">        :param update_interval: The interval between updates in seconds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span> <span class="o">=</span> <span class="n">proj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">analyses</span><span class="o">.</span><span class="n">CFGEmulated</span> <span class="o">=</span> <span class="n">cfg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">entry_point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">update_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coverage_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overall_coverage_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span><span class="p">:</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_coverage</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_total_blocks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_functions</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coverage_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">coverage_dir</span>

    <span class="k">def</span> <span class="nf">start_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the coverage monitoring thread.&quot;&quot;&quot;</span>

        <span class="c1"># clear the coverage directory</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coverage_dir</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;00&quot;</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">coverage_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_monitor_coverage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop_monitoring</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Stop the coverage monitoring thread.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitoring_thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_monitor_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Monitor the coverage and update the data periodically.&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_update_coverage</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">plot_coverage</span><span class="p">()</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_interval</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_analyze_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Analyze the current coverage using Angr.</span>

<span class="sd">        :return: A tuple containing overall coverage percentage and function-wise coverage data</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">overall_coverage</span><span class="p">,</span> <span class="n">function_coverage</span> <span class="o">=</span> <span class="n">analyze_coverage</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">,</span> <span class="s2">&quot;cov&quot;</span><span class="p">)</span>

        <span class="c1"># Convert the function_coverage to the format we need</span>
        <span class="n">formatted_coverage</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">func_addr</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">function_coverage</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">func_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">func_addr</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>
            <span class="n">formatted_coverage</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;covered_blocks&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;covered_blocks&#39;</span><span class="p">],</span>
                <span class="s2">&quot;total_blocks&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;total_blocks&#39;</span><span class="p">]</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">overall_coverage</span><span class="p">,</span> <span class="n">formatted_coverage</span>

    <span class="k">def</span> <span class="nf">_update_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update the coverage data and log the results.&quot;&quot;&quot;</span>
        <span class="n">overall_coverage</span><span class="p">,</span> <span class="n">function_coverage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_analyze_coverage</span><span class="p">()</span>
        <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span>

        <span class="n">total_blocks</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">new_functions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">function_coverage</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_functions</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--- Coverage Update at </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds ---&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">function_coverage</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">func_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coverage_data</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coverage_data</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">covered_blocks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;covered_blocks&#39;</span><span class="p">]</span>
            <span class="n">total_blocks</span> <span class="o">+=</span> <span class="n">covered_blocks</span>
            <span class="n">total_func_blocks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;total_blocks&#39;</span><span class="p">]</span>
            <span class="n">coverage_percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">covered_blocks</span> <span class="o">/</span> <span class="n">total_func_blocks</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">total_func_blocks</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">coverage_data</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">elapsed_time</span><span class="p">,</span> <span class="n">covered_blocks</span><span class="p">,</span> <span class="n">coverage_percentage</span><span class="p">))</span>

            <span class="c1"># Calculate difference from previous update</span>
            <span class="n">prev_covered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_coverage</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">func_name</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;covered_blocks&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">block_diff</span> <span class="o">=</span> <span class="n">covered_blocks</span> <span class="o">-</span> <span class="n">prev_covered</span>

            <span class="k">if</span> <span class="n">block_diff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">new_functions</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">covered_blocks</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function: </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2"> - Covered blocks: </span><span class="si">{</span><span class="n">covered_blocks</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total_func_blocks</span><span class="si">}</span><span class="s2"> &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">coverage_percentage</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%) [+</span><span class="si">{</span><span class="n">block_diff</span><span class="si">}</span><span class="s2"> blocks]&quot;</span><span class="p">)</span>

        <span class="c1"># Log overall statistics</span>
        <span class="n">new_total_blocks</span> <span class="o">=</span> <span class="n">total_blocks</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">previous_total_blocks</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Overall coverage: </span><span class="si">{</span><span class="n">overall_coverage</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">% [+</span><span class="si">{</span><span class="n">new_total_blocks</span><span class="si">}</span><span class="s2"> blocks total]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_functions</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Newly discovered functions: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_functions</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Update overall coverage data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overall_coverage_data</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">elapsed_time</span><span class="p">,</span> <span class="n">overall_coverage</span><span class="p">))</span>

        <span class="c1"># Update previous state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_coverage</span> <span class="o">=</span> <span class="n">function_coverage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_total_blocks</span> <span class="o">=</span> <span class="n">total_blocks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">previous_functions</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">function_coverage</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">plot_coverage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot the coverage evolution over time.&quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

        <span class="c1"># Plot overall coverage</span>
        <span class="n">times</span><span class="p">,</span> <span class="n">coverages</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">overall_coverage_data</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">coverages</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Overall Coverage&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (seconds)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Coverage (%)&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Overall Coverage Evolution Over Time&#39;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Plot function-wise coverage</span>
        <span class="k">for</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">coverage_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">times</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">coverages</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">coverages</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">func_name</span><span class="p">)</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (seconds)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Coverage (%)&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Function-wise Coverage Evolution Over Time&#39;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;center left&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">monitor_coverage</span><span class="p">(</span><span class="n">proj</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">analyses</span><span class="o">.</span><span class="n">CFGEmulated</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                     <span class="n">duration</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span> <span class="n">update_interval</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Monitor the coverage evolution for a specified duration.</span>

<span class="sd">    :param proj: The Angr project</span>
<span class="sd">    :param cfg: The Control Flow Graph</span>
<span class="sd">    :param entry_point: The entry point address</span>
<span class="sd">    :param duration: The duration to monitor in seconds</span>
<span class="sd">    :param update_interval: The interval between updates in seconds</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">monitor</span> <span class="o">=</span> <span class="n">CoverageMonitor</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">,</span> <span class="n">update_interval</span><span class="o">=</span><span class="n">update_interval</span><span class="p">)</span>
    <span class="n">monitor</span><span class="o">.</span><span class="n">start_monitoring</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">monitor</span><span class="o">.</span><span class="n">stop_monitoring</span><span class="p">()</span>
        <span class="n">monitor</span><span class="o">.</span><span class="n">plot_coverage</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">get_reachable_info</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">analyses</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">cfg_fast</span><span class="o">.</span><span class="n">CFGBase</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
    <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">angr</span><span class="o">.</span><span class="n">knowledge_plugins</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">cfg_node</span><span class="o">.</span><span class="n">CFGNode</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get reachable blocks and functions from the entry point in the CFG.</span>

<span class="sd">    Args:</span>
<span class="sd">        cfg: The control flow graph.</span>
<span class="sd">        entry_point: The entry point address.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing reachable blocks and reachable functions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">entry_node</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">knowledge_plugins</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">cfg_node</span><span class="o">.</span><span class="n">CFGNode</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get_any_node</span><span class="p">(</span><span class="n">entry_point</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">entry_node</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entry point </span><span class="si">{</span><span class="nb">hex</span><span class="p">(</span><span class="n">entry_point</span><span class="p">)</span><span class="si">}</span><span class="s2"> not found in CFG&quot;</span><span class="p">)</span>

    <span class="n">reachable_nodes</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">angr</span><span class="o">.</span><span class="n">knowledge_plugins</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">cfg_node</span><span class="o">.</span><span class="n">CFGNode</span><span class="p">]</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">descendants</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">graph</span><span class="p">,</span> <span class="n">entry_node</span><span class="p">)</span>
    <span class="n">reachable_nodes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">entry_node</span><span class="p">)</span>

    <span class="n">reachable_blocks</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">addr</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">reachable_nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">block</span><span class="p">)</span>

    <span class="n">reachable_functions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">angr</span><span class="o">.</span><span class="n">knowledge_plugins</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">cfg_node</span><span class="o">.</span><span class="n">CFGNode</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">reachable_nodes</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">function_address</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">reachable_functions</span><span class="p">:</span>
            <span class="n">reachable_functions</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">function_address</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">reachable_functions</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">function_address</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">reachable_blocks</span><span class="p">,</span> <span class="n">reachable_functions</span>


<span class="k">def</span> <span class="nf">read_coverage_files</span><span class="p">(</span><span class="n">coverage_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read coverage files and return a set of covered block addresses.</span>

<span class="sd">    Args:</span>
<span class="sd">        coverage_dir: The directory containing coverage files.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A set of covered block addresses.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">covered_blocks</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">coverage_dir</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;00&quot;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">coverage_dir</span><span class="p">,</span> <span class="n">filename</span><span class="p">),</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">covered_blocks</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="mi">16</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">covered_blocks</span>


<span class="k">def</span> <span class="nf">compare_coverage</span><span class="p">(</span><span class="n">proj</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">,</span> <span class="n">reachable_blocks</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
                     <span class="n">reachable_functions</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Set</span><span class="p">[</span><span class="n">angr</span><span class="o">.</span><span class="n">knowledge_plugins</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">cfg_node</span><span class="o">.</span><span class="n">CFGNode</span><span class="p">]],</span>
                     <span class="n">covered_blocks</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compare coverage between reachable blocks and covered blocks.</span>

<span class="sd">    Args:</span>
<span class="sd">        proj: The angr project.</span>
<span class="sd">        reachable_blocks: Set of reachable block addresses.</span>
<span class="sd">        reachable_functions: Dictionary of reachable functions and their nodes.</span>
<span class="sd">        covered_blocks: Set of covered block addresses.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing overall coverage and function coverage information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">total_reachable</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">reachable_blocks</span><span class="p">)</span>
    <span class="n">total_covered</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">covered_blocks</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">reachable_blocks</span><span class="p">))</span>
    <span class="n">overall_coverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">total_covered</span> <span class="o">/</span> <span class="n">total_reachable</span> <span class="k">if</span> <span class="n">total_reachable</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>

    <span class="n">function_coverage</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">func_addr</span><span class="p">,</span> <span class="n">nodes</span> <span class="ow">in</span> <span class="n">reachable_functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">func</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">knowledge_plugins</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">Function</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">kb</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">func_addr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">func</span><span class="p">:</span>
            <span class="n">func_blocks</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">addr</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">block</span><span class="p">)</span>
            <span class="n">covered_func_blocks</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">func_blocks</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">covered_blocks</span><span class="p">)</span>
            <span class="n">coverage</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">covered_func_blocks</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">func_blocks</span><span class="p">)</span> <span class="k">if</span> <span class="n">func_blocks</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">function_coverage</span><span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;address&#39;</span><span class="p">:</span> <span class="n">func_addr</span><span class="p">,</span>
                <span class="s1">&#39;total_blocks&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">func_blocks</span><span class="p">),</span>
                <span class="s1">&#39;covered_blocks&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">covered_func_blocks</span><span class="p">),</span>
                <span class="s1">&#39;coverage&#39;</span><span class="p">:</span> <span class="n">coverage</span>
            <span class="p">}</span>

    <span class="k">return</span> <span class="n">overall_coverage</span><span class="p">,</span> <span class="n">function_coverage</span>


<span class="k">def</span> <span class="nf">analyze_coverage</span><span class="p">(</span><span class="n">proj</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">Project</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">angr</span><span class="o">.</span><span class="n">analyses</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">cfg_fast</span><span class="o">.</span><span class="n">CFGBase</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                     <span class="n">coverage_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">coverage_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;reachable_blocks.txt&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Analyze coverage for the given project and CFG.</span>

<span class="sd">    Args:</span>
<span class="sd">        proj: The angr project.</span>
<span class="sd">        cfg: angr control flow graph.</span>
<span class="sd">        entry_point: The entry point address.</span>
<span class="sd">        coverage_dir: The directory containing coverage files.</span>
<span class="sd">        coverage_file: The coverage file to write to</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing overall coverage and function coverage information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reachable_blocks</span><span class="p">,</span> <span class="n">reachable_functions</span> <span class="o">=</span> <span class="n">get_reachable_info</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">entry_point</span><span class="p">)</span>
    <span class="n">covered_blocks</span> <span class="o">=</span> <span class="n">read_coverage_files</span><span class="p">(</span><span class="n">coverage_dir</span><span class="p">)</span>
    <span class="n">overall_coverage</span><span class="p">,</span> <span class="n">function_coverage</span> <span class="o">=</span> <span class="n">compare_coverage</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">reachable_blocks</span><span class="p">,</span> <span class="n">reachable_functions</span><span class="p">,</span> <span class="n">covered_blocks</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">coverage_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">hex</span><span class="p">(</span><span class="n">block</span><span class="p">)</span> <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">reachable_blocks</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">overall_coverage</span><span class="p">,</span> <span class="n">function_coverage</span>
</code></pre></div>

<p>And used as&nbsp;follows:</p>
<div class="codehilite"><pre><span></span><code><span class="n">monitor</span> <span class="o">=</span> <span class="n">coverage</span><span class="o">.</span><span class="n">CoverageMonitor</span><span class="p">(</span><span class="n">shared</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span> <span class="n">shared</span><span class="o">.</span><span class="n">cfg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_point</span><span class="p">,</span> <span class="n">update_interval</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">coverage_dir</span><span class="o">=</span><span class="s2">&quot;cov&quot;</span><span class="p">)</span>
<span class="n">monitor</span><span class="o">.</span><span class="n">start_monitoring</span><span class="p">()</span>
</code></pre></div>

<h1 id="conclusion">Conclusion</h1>
<p>Thanks to these new tools in your toolbox, I hope you&#8217;ll get a better user experience with <code>angr</code> and (again) give it a chance. It really is an awesome&nbsp;framework!</p>
	</div>

	<div id="related-articles">
		<a href="/angr-2024.html" id="prev-neighbour">Using angr in 2024 &raquo;</a>
	</div>

			<hr>
		</article>

		<footer>
			<p>Powered by <a href="http://getpelican.com">Pelican</a> (<a href="https://github.com/iKevinY/pneumatic">Pneumatic Theme</a>) and <a href="http://pages.github.com">GitHub&nbsp;Pages</a>.</p>
		</footer>
	</div>


</body>
</html>